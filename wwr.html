<html>

<head>
    <link rel="stylesheet" type="text/css" href="./wwr.css">
</head>

<body>
    <style>
        .MathJax {
            outline: 0;
        }
    </style>
    <div id="dialogs" class="lg-content-left">
        <article hidden class="am-comment am-comment-primary">
            <div class="lg-left"><a class="center"><img src="http://172.22.21.53/img?id=123123"
                        class="am-comment-avatar"></a></div>
            <div class="am-comment-main">
                <header class="am-comment-hd">
                    <div class="am-comment-meta"><a class="lg-fg-red lg-bold">123123</a><a
                            class="lg-fg-green lg-bold">172.22.21.27</a>2019年10月11日 19:55:33<a
                            href='javascript: cancelmsg({"name":"123123","ip":"172.22.21.27","word":"啥情况\n\n","time":"2019年10月11日 19:55:33"});'>撤回</a>
                    </div>
                </header>
                <div class="am-comment-bd">
                    <p> 啥情况 </p>
                </div>
            </div>
        </article>
    </div>
    <hr>
    <div style="margin-left: 1%">
        <p> 信息 </p>
        <textarea rows="3" cols="100%" type="text" id="msg" maxlength="128" onchange="doPreView();"
            oninput="doPreView();"></textarea>
        <hr>
        <p> 预览 </p>
        <div id="preview" style="margin-left: 0; border:1px solid #0012">
            <p id="preview_text"></p>
        </div>
    </div>
    <hr>
    <div>
        <input type="button" value="发送" onclick="sendmsg();" class="am-btn am-btn-primary am-btn-sm"
            style="float: left; margin-right: 1%;">
        <form id="form_refresh" action="" method="post" onsubmit="refresh(); return false;">
            <input type="submit" value="刷新" class="am-btn am-btn-primary am-btn-sm" style="float: left; margin-right: 1%;">
        </form>
        <a href="http://172.22.21.53/imgupload" style="float: left; margin-right: 1%;">上传头像</a>
        <a href="http://172.22.21.53/index.html" style="float: left; margin-right: 1%;">重新登录</a>
    </div>
    <hr>

    <div id="float" style="z-index:999;display: block; position: fixed; right: 0px; bottom: 10%;">
        <img onclick="scrollBottom();" src="http://172.22.21.53/img_sys?pic=scroll_bottom.png" width="50">
        <img id="redpoint" onclick="document.getElementById('redpoint').remove();"
            src="http://172.22.21.53/img_sys?pic=red.png" style="position:absolute;right:0%;top:0%;border-radius:50%;">
    </div>
    <br>
    <br>
    <br>
    <script type="text/javascript">
        function displayRedPoint() {
            if (document.getElementById("redpoint") != null) return;
            var node = document.createElement("img");
            node.setAttribute("id", "redpoint");
            node.setAttribute("onclick", "document.getElementById('redpoint').remove();");
            node.setAttribute("src", "http://172.22.21.53/img_sys?pic=red.png");
            node.setAttribute("style", "position:absolute;right:0%;top:0%;border-radius:50%;");
            document.getElementById("float").appendChild(node);
        }
        function scrollBottom() {
            if (document.getElementById('redpoint') != null)
                document.getElementById('redpoint').remove();
            scrollTo(0, document.body.scrollHeight);
        }
    </script>
    <script>
        window.onscroll = function () {
            //console.log(window.scrollY + "/" + (document.getElementById("dialogs").scrollHeight - window.innerHeight));
            if (window.scrollY >= document.getElementById("dialogs").scrollHeight - window.innerHeight) {
                if (document.getElementById('redpoint') != null)
                    document.getElementById('redpoint').remove();
            }
        }
        document.onkeypress = function (e) {
            var keyNum = window.event ? e.keyCode : e.which;
            //console.log(e.ctrlKey);
            //console.log(keyNum);
        }
        var first_refresh = true;
        setInterval(function () {
            refresh(first_refresh);
            first_refresh = false;
        }, 1000);
        var oldmsg = "";
        function getDialogHtml(name, ip, time, word) {
            console.log(word);
            var node = document.createElement("article");
            node.setAttribute("class", "am-comment am-comment-primary");
            var divimg = document.createElement("div");
            divimg.setAttribute("class", "lg-left");
            var aimg = document.createElement("a");
            aimg.setAttribute("class", "center");
            var img = document.createElement("img");
            img.setAttribute("src", "http://172.22.21.53/img?id=" + name);
            img.setAttribute("class", "am-comment-avatar");
            aimg.appendChild(img);
            divimg.appendChild(aimg);
            node.appendChild(divimg);
            var divmain = document.createElement("div");
            divmain.setAttribute("class", "am-comment-main");
            var header = document.createElement("header");
            header.setAttribute("class", "am-comment-hd");
            var divmeta = document.createElement("div");
            divmeta.setAttribute("class", "am-comment-meta");
            var a = document.createElement("a");
            a.setAttribute("class", "lg-fg-red lg-bold");
            a.appendChild(document.createTextNode(name));
            divmeta.appendChild(a);

            a = document.createElement("a");
            a.setAttribute("class", "lg-fg-green lg-bold");
            a.appendChild(document.createTextNode(ip));
            divmeta.appendChild(a);
            divmeta.appendChild(document.createTextNode(time));

            a = document.createElement("a");
            a.appendChild(document.createTextNode("撤回"));
            a.setAttribute("href", "javascript: cancelmsg(" + JSON.stringify({ name: name, ip: ip, word: word, time: time }) + ");");
            divmeta.appendChild(a);

            var divbd = document.createElement("div");
            divbd.setAttribute("class", "am-comment-bd");
            var words = document.createElement("p");
            words.appendChild(document.createTextNode(word));
            node.appendChild(divmain);
            divmain.appendChild(header);
            header.appendChild(divmeta);
            divmain.appendChild(divbd);
            divbd.appendChild(words);
            return node;
        }
        function clearDialog() {
            var newnode = document.createElement("div");
            newnode.setAttribute("id", "dialogs");
            newnode.setAttribute("class", "lg-content-left");
            //document.getElementById("dialogs").replaceWith(newnode);
            //document.body.insertBefore
            if (document.getElementById("dialogs") != null)
                document.getElementById("dialogs").remove();
            document.body.insertBefore(newnode, document.getElementById("message"))
        }
        function appendDialog(name, ip, time, word, flag) {
            var node = getDialogHtml(name, ip, time, word);
            if (flag == true)
                LatexGo(node);
            document.getElementById("dialogs").appendChild(node);
        }
        function getTime() {
            var date = new Date();
            var year = date.getFullYear();
            var month = date.getMonth() + 1;
            var day = date.getDate();
            var hour = date.getHours();
            var minute = date.getMinutes();
            var second = date.getSeconds();
            return year + '年' + month + '月' + day + '日 ' + hour + ':' + minute + ':' + second;
        }
        function cancelmsg(msg) {
            console.log(msg);
            //alert(JSON.stringify(msg));
            var httpRequest = new XMLHttpRequest();
            httpRequest.open("POST", 'cancelmsg', false);
            httpRequest.send(JSON.stringify(msg));
            switch (httpRequest.responseText) {
                case "succeed": refresh(false); return;
                case "failed": alert("撤回失败"); return;
                default: alert("未知错误");
            }
        }
        function sendmsg() {
            //alert('sendmsg:' + document.getElementById("msg").value);
            var httpRequest = new XMLHttpRequest();
            httpRequest.open("POST", 'sendmsg', false);
            //xmlhttp.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
            var msgjson = {
                //name: document.getElementById("name").value,
                word: document.getElementById("msg").value
            };
            document.getElementById("msg").value = "";
            doPreView();
            httpRequest.send(JSON.stringify(msgjson));
            refresh();
            switch (httpRequest.responseText) {
                case "succeed": return;
                case "ban": alert("你已被禁言");
            }
        }
        function msgArrayEqu(a1, a2, len) {
            for (var i = 0; i < len; i++) {
                if (a1[i].name != a2[i].name
                    || a1[i].word != a2[i].word
                    || a1[i].ip != a2[i].ip
                    || a1[i].time != a2[i].time) return false;
            }
            return true;
        }
        function refresh(flag) {
            var httpRequest = new XMLHttpRequest();
            httpRequest.open("POST", 'getmsg', false);
            if (flag == true)
                httpRequest.send("first");
            else
                httpRequest.send();
            var str = httpRequest.responseText;
            if (str == "no_new") { console.log("no_new"); return; }
            if (str == oldmsg) return;
            //console.log(str);
            //console.log(JSON.parse(str));
            var msgs = new Array();
            msgs = JSON.parse(str);
            if (oldmsg != "")
                var oldarray = JSON.parse(oldmsg);
            if (oldmsg != ""
                && oldarray.length < msgs.length
                && msgArrayEqu(msgs, oldarray, oldarray.length)) {
                console.log("append");
                for (var i = oldarray.length; i < msgs.length; i++) {
                    appendDialog(msgs[i].name, msgs[i].ip, msgs[i].time, msgs[i].word, true);
                }
            } else {
                //alert("clear");
                console.log("clear");
                clearDialog();
                for (var i = 0; i < msgs.length; i++) {
                    appendDialog(msgs[i].name, msgs[i].ip, msgs[i].time, msgs[i].word, false);
                }
                LatexGo(document.getElementById("dialogs"));
            }
            displayRedPoint();
            oldmsg = str;
        }
        function LatexGo(node) { MathJax.Hub.Queue(["Typeset", MathJax.Hub, node]); }

        function doPreView() {
            var node = document.getElementById("preview_text");
            while (node.firstChild != null)
                node.firstChild.remove();
            node.appendChild(document.createTextNode(document.getElementById("msg").value));
            LatexGo(node);
        }

    </script>
    <script src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/x-mathjax-config">
        MathJax.Hub.Config({
        showProcessingMessages: false,
        messageStyle: "none",
        tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre','code','a'],
        inlineMath: [ ['$','$'], ["\\(","\\)"] ],
        displayMath: [ ['$$','$$'], ["\\[","\\]"] ]
        },
        "HTML-CSS": {
        availableFonts: ["STIX","TeX"],
        showMathMenu: false
        }
        });
        MathJax.Hub.Queue(["Typeset",MathJax.Hub]);
    </script>
</body>

</html>